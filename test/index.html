<!DOCTYPE html>
<html lang="">
    <head>
        <meta charset="utf-8">
        <title></title>
        <link rel="stylesheet" href="style.css">
    </head>
    <body onload="init()">
      <header>
        <h1>Y(et) A(nother) T(ext) E(ditor)</h1>
        <div class="menu">
            <input type="text"/>
            <button onclick="open_file(this.previousElementSibling.value)">Open</button>
        </div>
      </header>
      <main>
          <div class="tree">
              <ul id="dir_tree">
              </ul>
              <div id="sse_display"></div>
          </div>
          <div class="main editor">
              <div class="line-numbers">
                <span></span>
              </div>
              <textarea id="text_div" contenteditable="true"></textarea>
          </div>
      </main>
      <footer></footer>
    </body>
    <script>
    function open_file(filename)
    {
        fetch('./open?file=' + filename)
            .then((response) => {
                response.text().then((data) => {
                    const regex = /(\<\/?[a-z]\>?)/
                    const new_data = data.replace(regex, "<span style='color:red;'>$1</span>");
                    const textarea = document.querySelector("#text_div");
                    textarea.value = data;
                    update_line_numbers(textarea);
                });
            })
            .catch((err) => {  })
    }
    function update_line_numbers(textarea){
        const lineNumbers = document.querySelector(".line-numbers");
        const numberOfLines = textarea.value.split('\n').length;
        lineNumbers.innerHTML = Array(numberOfLines)
            .fill('<span></span>')
            .join('')
    }

    function init()
    {
        const textarea = document.querySelector("#text_div");

        textarea.addEventListener('keyup', event => {
            update_line_numbers(event.target);
        });

        console.log("Request...");
        fetch('./style.css')
            .then((response) => {
                response.text().then((data) => {
                    const regex = /(font)/
                    const new_data = data.replace(regex, "<span style='color:red;'>$1</span>$2");
                    //const textarea = document.querySelector("#text_div");
                    textarea.value = data;
                    update_line_numbers(textarea);
                });
            })
            .catch((err) => {  });
    }

/*
    function getCaretPosition(editableDiv) {
        var caretPos = 0,
            sel, range;
        if (window.getSelection) {
            sel = window.getSelection();
            if (sel.rangeCount) {
            range = sel.getRangeAt(0);
                if (range.commonAncestorContainer.parentNode == editableDiv) {
                    caretPos = range.endOffset;
                }
            }
        } else if (document.selection && document.selection.createRange) {
            range = document.selection.createRange();
            if (range.parentElement() == editableDiv) {
                var tempEl = document.createElement("span");
                editableDiv.insertBefore(tempEl, editableDiv.firstChild);
                var tempRange = range.duplicate();
                tempRange.moveToElementText(tempEl);
                tempRange.setEndPoint("EndToEnd", range);
                caretPos = tempRange.text.length;
            }
        }
        return caretPos;
    }
*/
    const evtSource = new EventSource("event");
    evtSource.onmessage = (event) => {
        //const newElement = document.createElement("li");
        //const eventList = document.getElementById("list");

        const text_div = document.querySelector("#text_div");
        //let cpos = cursor_position();
        let start = text_div.selectionStart;
        let end = text_div.selectionEnd;
        //console.log(cpos);
        const len = text_div.value.length;
        text_div.value = text_div.value.replace(text_div.value[+event.data % len], 'a');
        //console.log(text_div.innerText[+event.data % len]);
        document.querySelector("#sse_display").innerHTML = `message: ${event.data}`;
        //console.log(text_div);
        if(document.activeElement === text_div)
            text_div.setSelectionRange(start,end);
        //text_div.focus();
        //text_div.selectionStart = start;
        //text_div.selectionEnd = end;
        //eventList.appendChild(newElement);
    };
    </script>
</html>
